---
title: "R Notebook"
output: html_notebook
---
```{r}
library(car)
library(tidyverse)
library(modelr)
library(skimr)
library(GGally)
```
```{r}
skim(Prestige)
```
```{r}
prestige_trim <- Prestige %>% 
  drop_na() %>% 
  select(-census)
```

feature engineering / varibale transformation
```{r}
prestige_trim <- prestige_trim %>% 
  mutate(ln_women = log(1 + women), #1 + as some were 0, which cant be ln'd
         ln_income = log(income)) #taking logs to reduce skew
```

```{r}
prestige_trim %>% 
  select(-c(ln_women:ln_income)) %>% 
  select(prestige, everything()) %>% 
  ggpairs(aes(colour = type,
              alpha = 0.5))
```
```{r}
prestige_trim %>% 
  select(prestige, ln_women:ln_income, type) %>% 
  ggpairs(aes(colour = type,
              alpha = 0.5))
```
ln_income has a higher correlation with prestige (0.75) than income and reduces effect of outliers

###build on best predictor first (education)
```{r}
mode1a <- lm(prestige ~ education,
             data = prestige_trim)

summary(mode1a)
```
```{r}
library(ggfortify)
autoplot(mode1a)
```

```{r}
mod1b <- mode1a <- lm(prestige ~ type,
             data = prestige_trim)

summary(mod1b)

autoplot(mod1b)
```
education appears to better predictor of prestige (r^2), so this is our first variable

###which variables best explain the "residue" i.e. the unexplained errors in model - second predictor

```{r}
prestige_resid <- prestige_trim %>% 
  add_residuals(mode1a) %>% 
  select(-c(prestige, education))

prestige_resid %>% 
  select(resid, everything()) %>% 
  ggpairs(aes(colour = type, alpha = 0.5))
```
```{r}
mod2a <- lm(prestige ~ education + ln_income,
            data = prestige_trim)

summary(mod2a)

autoplot(mod2a)
```
```{r}
mod2b <- lm(prestige ~ education + income,
            data = prestige_trim)

summary(mod2b)
```
proves ln income is superior to income 

```{r}
mod2c <- lm(prestige ~ education + type,
            data = prestige_trim)

summary(mod2c)
```
ln income is still the most useful second predictor for the model (mod2a best)


###check whether have all categorical predictors or none (ANOVA)
```{r}
anova(mode1a, mod2c) #has no categories, has all catgories
```
analysis of variance shows statistical significance (3 types have different means), so we can include type in the model 

###third predictor
```{r}
prestige_resid <- prestige_trim %>% 
  add_residuals(mod2a) %>% 
  select(-c(prestige, education, ln_income))

prestige_resid %>% 
  select(resid, everything()) %>% 
  ggpairs(aes(colour = type, alpha = 0.5))
```
```{r}
mod3a <- lm(prestige ~ education + ln_income + women,
            data = prestige_trim)

summary(mod3a)
```
```{r}
mod3b <- lm(prestige ~ education + ln_income + type,
            data = prestige_trim)

summary(mod3b)

autoplot(mod3b)
```
check anova for type 
```{r}
anova(mod2a, mod3b)
```
we can include type as significant from anova test (3b is best model)

###adding interaction?
```{r}
prestige_resid <- prestige_trim %>% 
  add_residuals(mod3b) %>% 
  select(-prestige)
```

```{r}
coplot(resid ~ ln_income | education,
       panel = function(x, y, ...){
         points(x, y)
         abline(lm(y ~ x), col = "blue")
       },
       data = prestige_resid,
       rows = 1)
#shows that the way we are wrong changes for different education groups: suggests interaction is worth including
```
```{r}
prestige_resid %>% 
  ggplot(aes(x = education, y = resid, colour = type))+
  geom_point()+
  geom_smooth(method = "lm", se = FALSE)
#education and type relationship worth including
```
```{r}
prestige_resid %>% 
  ggplot(aes(x = ln_income, y = resid, colour = type))+
  geom_point()+
  geom_smooth(method = "lm", se = FALSE)

#income and type relationship worth including
```
```{r}
mod4a <- lm(prestige ~ education + ln_income + type +
              education:ln_income,
            data = prestige_trim)

summary(mod4a)
```
```{r}
mod4b <- lm(prestige ~ education + ln_income + type +
              education:type,
            data = prestige_trim)

summary(mod4b)
```
```{r}
mod4c <- lm(prestige ~ education + ln_income + type +
              ln_income:type,
            data = prestige_trim)

summary(mod4c)
```
top interaction candidate basdd on r^2 and p value

```{r}
autoplot(mod4c)
```
```{r}
anova(mod3b, mod4c)
```

###relative importance of variables 
```{r}
library(relaimpo)

calc.relimp(mod4c, type = "lmg", rela = TRUE)
```

```{r}
mod4c
```

